
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Dependency &#8212; dotty-cps-async 0.9.21 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/nature.css" />
    <link rel="stylesheet" type="text/css" href="_static/css/s4defs-roles.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="High-order functions." href="HighOrderFunctions.html" />
    <link rel="prev" title="User Manual" href="index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="HighOrderFunctions.html" title="High-order functions."
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="User Manual"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">dotty-cps-async 0.9.21 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Dependency</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="dependency">
<h1>Dependency<a class="headerlink" href="#dependency" title="Permalink to this heading">¶</a></h1>
<section id="sbt-example">
<h2>Sbt Example<a class="headerlink" href="#sbt-example" title="Permalink to this heading">¶</a></h2>
<p>The current prerelease is <a href="#id7"><span class="problematic" id="id8">|0.9.21|</span></a> for using with Scala <a href="#id11"><span class="problematic" id="id12">|3.3.3|_</span></a>.</p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">libraryDependencies</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot;com.github.rssh&quot;</span><span class="w"> </span><span class="o">%%</span><span class="w"> </span><span class="s">&quot;dotty-cps-async&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;0.9.21&quot;</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>JavaScript and Native targets are also supported.</p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">libraryDependencies</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot;com.github.rssh&quot;</span><span class="w"> </span><span class="o">%%%</span><span class="w"> </span><span class="s">&quot;dotty-cps-async&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;0.9.21&quot;</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p><strong>Note</strong>: <span class="red">%%%</span> automatically determines whether we are in a Scala/JVM or a Scala.js or a Scala.Native project (see <a class="reference external" href="https://www.scala-js.org/doc/project/cross-build.html"><strong>Scala.js Cross-Building</strong></a>).</p>
</section>
<section id="compiler-plugin">
<h2>Compiler Plugin<a class="headerlink" href="#compiler-plugin" title="Permalink to this heading">¶</a></h2>
<p>For using direct context encoding (now marked as <cite>&#64;experimental</cite>) you also need to add compiler-plugin:</p>
<p>for sbt:</p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">autoCompilerPlugins</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="n">addCompilerPlugin</span><span class="p">(</span><span class="s">&quot;com.github.rssh&quot;</span><span class="w"> </span><span class="o">%%</span><span class="w"> </span><span class="s">&quot;dotty-cps-async-compiler-plugin&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;0.9.21&quot;</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>for mill:</p>
<blockquote>
<div><blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div></blockquote>
<p>def scalacPluginIvyDeps = Agg(ivy”com.github.rssh::dotty-cps-async-compiler-plugin:0.9.21”)</p>
</div></blockquote>
</section>
<section id="loom-support-on-jvm">
<h2>Loom support on JVM<a class="headerlink" href="#loom-support-on-jvm" title="Permalink to this heading">¶</a></h2>
<p>If you use JDK-21 or later you can find helpful loom-based support for transforming arguments of high-order functions.
To enable one, add <cite>dotty-cps-async-loom</cite> module to the dependencies:</p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">libraryDependencies</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot;com.github.rssh&quot;</span><span class="w"> </span><span class="o">%%</span><span class="w"> </span><span class="s">&quot;dotty-cps-async-loom&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;0.9.21&quot;</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</section>
</section>
<section id="basic-usage">
<h1>Basic Usage<a class="headerlink" href="#basic-usage" title="Permalink to this heading">¶</a></h1>
<section id="traditional-async-await-interface">
<h2>Traditional async/await interface<a class="headerlink" href="#traditional-async-await-interface" title="Permalink to this heading">¶</a></h2>
<p>The usage is similar to working with async/await frameworks in Scala 2 (e.g. <a class="reference external" href="https://github.com/scala/scala-async"><code class="docutils literal notranslate"><span class="pre">scala-async</span></code></a>) and in other languages.</p>
<p>We define two ‘pseudo-functions’ <a class="reference external" href="https://github.com/rssh/dotty-cps-async/blob/master/shared/src/main/scala/cps/Async.scala#L30"><code class="docutils literal notranslate"><span class="pre">async</span></code></a> and <a class="reference external" href="https://github.com/rssh/dotty-cps-async/blob/master/shared/src/main/scala/cps/Async.scala#L19"><code class="docutils literal notranslate"><span class="pre">await</span></code></a> <a class="footnote-reference brackets" href="#f1" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> :</p>
<blockquote>
<div><span class="target" id="index-0"></span><div class="highlight-scala notranslate" id="index-1"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">async</span><span class="p">[</span><span class="nc">F</span><span class="p">[</span><span class="n">_</span><span class="p">],</span><span class="w"> </span><span class="nc">T</span><span class="p">](</span><span class="k">using</span><span class="w"> </span><span class="n">am</span><span class="p">:</span><span class="w"> </span><span class="nc">CpsMonad</span><span class="p">[</span><span class="nc">F</span><span class="p">])(</span><span class="n">expr</span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nc">F</span><span class="p">[</span><span class="nc">T</span><span class="p">]</span><span class="w"></span>

<span class="k">def</span><span class="w"> </span><span class="nf">await</span><span class="p">[</span><span class="nc">F</span><span class="p">[</span><span class="n">_</span><span class="p">],</span><span class="w"> </span><span class="nc">T</span><span class="p">](</span><span class="n">f</span><span class="p">:</span><span class="w"> </span><span class="nc">F</span><span class="p">[</span><span class="nc">T</span><span class="p">])(</span><span class="k">using</span><span class="w"> </span><span class="nc">CpsMonad</span><span class="p">[</span><span class="nc">F</span><span class="p">]):</span><span class="w"> </span><span class="nc">T</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>Inside the async block, we can use the <a class="reference external" href="https://github.com/rssh/dotty-cps-async/blob/master/shared/src/main/scala/cps/Async.scala#L19"><code class="docutils literal notranslate"><span class="pre">await</span></code></a> pseudo-function.</p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">cps</span><span class="p">.</span><span class="n">_</span>

<span class="k">def</span><span class="w"> </span><span class="nf">myFun</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="p">[</span><span class="nc">MyMonad</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ... here is possible to use await:</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="p">(</span><span class="n">something</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<span class="target" id="index-2"></span></div></blockquote>
<p id="index-3">In the above code, the type <code class="docutils literal notranslate"><span class="pre">MyMonad</span></code> must implement one of the two type classes <a class="reference external" href="https://github.com/rssh/dotty-cps-async/blob/master/shared/src/main/scala/cps/CpsMonad.scala#L20"><code class="docutils literal notranslate"><span class="pre">CpsMonad</span></code></a> or <a class="reference external" href="https://github.com/rssh/dotty-cps-async/blob/ff25b61f93e49a1ae39df248dbe4af980cd7f948/shared/src/main/scala/cps/CpsMonad.scala#L70"><code class="docutils literal notranslate"><span class="pre">CpsTryMonad</span></code></a> (which supports try/catch).</p>
<p>The minimal complete snippet looks as follows:</p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">package</span><span class="w"> </span><span class="nn">com</span><span class="p">.</span><span class="nn">example</span><span class="p">.</span><span class="n">myModule</span>

<span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">concurrent</span><span class="p">.{</span><span class="nc">Await</span><span class="p">,</span><span class="w"> </span><span class="nc">Future</span><span class="p">}</span>
<span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">concurrent</span><span class="p">.</span><span class="nc">ExecutionContext</span><span class="p">.</span><span class="nc">Implicits</span><span class="p">.</span><span class="n">global</span>
<span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">concurrent</span><span class="p">.</span><span class="nn">duration</span><span class="p">.</span><span class="nc">Duration</span>
<span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">util</span><span class="p">.{</span><span class="nc">Failure</span><span class="p">,</span><span class="w"> </span><span class="nc">Success</span><span class="p">}</span>
<span class="k">import</span><span class="w"> </span><span class="nn">cps</span><span class="p">.</span><span class="n">*</span><span class="w">                  </span><span class="c1">// async, await</span>
<span class="k">import</span><span class="w"> </span><span class="nn">cps</span><span class="p">.</span><span class="nn">monads</span><span class="p">.{</span><span class="n">*</span><span class="p">,</span><span class="w"> </span><span class="k">given</span><span class="p">}</span><span class="w">  </span><span class="c1">// support for built-in monads (i.e. Future)</span>

<span class="k">object</span><span class="w"> </span><span class="nc">Example</span><span class="p">:</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">fetchGreeting</span><span class="p">():</span><span class="w"> </span><span class="nc">Future</span><span class="p">[</span><span class="nc">String</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="c1">// dummy async function</span>
<span class="w">    </span><span class="nc">Future</span><span class="w"> </span><span class="n">successful</span><span class="w"> </span><span class="s">&quot;Hi&quot;</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">greet</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="p">[</span><span class="nc">Future</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">greeting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="p">(</span><span class="n">fetchGreeting</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="n">greeting</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">]):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Await</span><span class="p">.</span><span class="n">ready</span><span class="p">(</span><span class="n">greet</span><span class="p">(),</span><span class="w"> </span><span class="nc">Duration</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="n">seconds</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="n">f</span><span class="p">.</span><span class="n">failed</span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ex</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">println</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">getMessage</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>This minimal example is for <a class="reference external" href="https://www.scala-lang.org/api/current/scala/concurrent/Future.html"><code class="docutils literal notranslate"><span class="pre">Future</span></code></a> monad and depends on library <a class="reference external" href="https://github.com/rssh/dotty-cps-async#dotty-cps-async"><strong>dotty-cps-async</strong></a> to be added to our project file <code class="docutils literal notranslate"><span class="pre">build.sbt</span></code> :</p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// https://mvnrepository.com/artifact/com.github.rssh/dotty-cps-async</span>
<span class="n">libraryDependencies</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s">&quot;com.github.rssh&quot;</span><span class="w"> </span><span class="o">%%</span><span class="w"> </span><span class="s">&quot;dotty-cps-async&quot;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;0.9.19&quot;</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p><strong>Note</strong>: The <a class="reference internal" href="Integrations.html#integrations"><span class="std std-ref">Integrations</span></a> section lists further library dependencies needed for integration with well-known monadic frameworks such as <a class="reference external" href="https://typelevel.org/cats-effect/"><strong>Cats Effect</strong></a>, <a class="reference external" href="https://monix.io/"><strong>Monix</strong></a>, <a class="reference external" href="https://scalaz.github.io"><strong>ScalaZ IO</strong></a> or <a class="reference external" href="https://zio.dev/"><strong>ZIO</strong></a> and streaming frameworks like <a class="reference external" href="https://doc.akka.io/docs/akka/current/stream/"><strong>Akka Streams</strong></a> and <a class="reference external" href="https://fs2.io"><strong>Fs2</strong></a>.</p>
<p>A monad  can also be abstracted out as in the following example:</p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">trait</span><span class="w"> </span><span class="nc">Handler</span><span class="p">[</span><span class="nc">F</span><span class="p">[</span><span class="n">_</span><span class="p">]:</span><span class="w"> </span><span class="nc">CpsTryMonad</span><span class="p">]:</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">():</span><span class="w"> </span><span class="nc">F</span><span class="p">[</span><span class="nc">Unit</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="p">[</span><span class="nc">F</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="p">(</span><span class="n">openConnection</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="k">try</span><span class="w"></span>
<span class="w">      </span><span class="k">while</span><span class="w"></span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="p">(</span><span class="n">readCommand</span><span class="p">(</span><span class="n">connection</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">logCommand</span><span class="p">(</span><span class="n">command</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="n">reply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="p">(</span><span class="n">handle</span><span class="p">(</span><span class="n">command</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">reply</span><span class="p">.</span><span class="n">isMuted</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<span class="w">          </span><span class="n">await</span><span class="p">(</span><span class="n">connection</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">reply</span><span class="p">.</span><span class="n">toBytes</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="o">!</span><span class="n">command</span><span class="p">.</span><span class="n">isShutdown</span><span class="w"></span>
<span class="w">      </span><span class="k">do</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">finally</span><span class="w"></span>
<span class="w">      </span><span class="n">connection</span><span class="p">.</span><span class="n">close</span><span class="p">()</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>The <a class="reference external" href="https://github.com/rssh/dotty-cps-async/blob/master/shared/src/main/scala/cps/Async.scala#L30"><code class="docutils literal notranslate"><span class="pre">async</span></code></a> macro will transform the code block into something like</p>
<blockquote>
<div><details>
 <summary><a>transformed code</a></summary><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="p">.</span><span class="n">flatMap</span><span class="p">(</span><span class="n">openConnection</span><span class="p">())(</span><span class="n">a</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">connection</span><span class="p">:</span><span class="w"> </span><span class="nc">Connection</span><span class="p">[</span><span class="nc">F</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="w">  </span><span class="n">m</span><span class="p">.</span><span class="n">withAction</span><span class="p">({</span><span class="w"></span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">_whilefun</span><span class="p">():</span><span class="w"> </span><span class="nc">F</span><span class="p">[</span><span class="nc">Unit</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">      </span><span class="n">m</span><span class="p">.</span><span class="n">flatMap</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">m</span><span class="p">.</span><span class="n">flatMap</span><span class="p">(</span><span class="n">readCommand</span><span class="p">(</span><span class="n">connection</span><span class="p">))((</span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nc">Command</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="kd">val</span><span class="w"> </span><span class="n">command</span><span class="p">:</span><span class="w"> </span><span class="nc">Command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="w">          </span><span class="n">logCommand</span><span class="p">(</span><span class="n">command</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span><span class="n">m</span><span class="p">.</span><span class="n">flatMap</span><span class="p">(</span><span class="n">handle</span><span class="p">(</span><span class="n">command</span><span class="p">))((</span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nc">Reply</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">             </span><span class="kd">val</span><span class="w"> </span><span class="n">reply</span><span class="p">:</span><span class="w"> </span><span class="nc">Reply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="w">             </span><span class="n">m</span><span class="p">.</span><span class="n">flatMap</span><span class="p">(</span><span class="w"></span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">reply</span><span class="p">.</span><span class="n">isMuted</span><span class="p">)</span><span class="w"></span>
<span class="w">                 </span><span class="n">connection</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">reply</span><span class="p">.</span><span class="n">toBytes</span><span class="p">)</span><span class="w"></span>
<span class="w">               </span><span class="k">else</span><span class="w"></span>
<span class="w">                  </span><span class="n">m</span><span class="p">.</span><span class="n">pure</span><span class="p">(())</span><span class="w"></span>
<span class="w">             </span><span class="p">)(</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">pure</span><span class="p">(</span><span class="o">!</span><span class="n">command</span><span class="p">.</span><span class="n">isShutdown</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="p">})</span><span class="w"></span>
<span class="w">        </span><span class="p">}))(</span><span class="n">c</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="n">_whilefun</span><span class="p">()</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">pure</span><span class="p">(()))</span><span class="w"></span>
<span class="w">    </span><span class="n">_whilefun</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">})(</span><span class="w"></span>
<span class="w">    </span><span class="n">m</span><span class="p">.</span><span class="n">pure</span><span class="p">(</span><span class="n">connection</span><span class="p">.</span><span class="n">close</span><span class="p">())</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</pre></div>
</div>
</details></div></blockquote>
<p>Since we use optimized monadic transform as the transformation technique, the number of monadic brackets will be  the
same as the number of <a class="reference external" href="https://github.com/rssh/dotty-cps-async/blob/master/shared/src/main/scala/cps/Async.scala#L19"><code class="docutils literal notranslate"><span class="pre">await</span></code></a> s in the source code.
You can read the <a class="reference internal" href="random-notes/index.html#random-notes"><span class="std std-ref">notes about implementation details</span></a>.</p>
</section>
<section id="direct-context-encoding-experimental">
<h2>Direct context encoding. (experimental)<a class="headerlink" href="#direct-context-encoding-experimental" title="Permalink to this heading">¶</a></h2>
<p>Direct context encoding allows the representation of asynchronous API as ordinary synchronous calls using context parameter CpsDirect[F].
The signature above is an example of a function in direct encoding:</p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w">  </span><span class="nf">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">:</span><span class="nc">String</span><span class="p">)(</span><span class="k">using</span><span class="w"> </span><span class="nc">CpsDirect</span><span class="p">[</span><span class="nc">Future</span><span class="p">]):</span><span class="w"> </span><span class="nc">String</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>Usage:</p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">fetchAccessible</span><span class="p">(</span><span class="n">urls</span><span class="p">:</span><span class="nc">List</span><span class="p">[</span><span class="nc">String</span><span class="p">])(</span><span class="k">using</span><span class="w"> </span><span class="nc">CpsDirect</span><span class="p">[</span><span class="nc">Future</span><span class="p">]):</span><span class="w"> </span><span class="nc">Map</span><span class="p">[</span><span class="nc">String</span><span class="p">,</span><span class="nc">String</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">       </span><span class="n">urls</span><span class="p">.</span><span class="n">flatMap</span><span class="p">{</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">            </span><span class="k">try</span><span class="w"></span>
<span class="w">                </span><span class="nc">Some</span><span class="p">((</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">)))</span><span class="w"></span>
<span class="w">            </span><span class="k">catch</span><span class="w"></span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="nc">NonFatal</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">                   </span><span class="n">logger</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">s&quot;Can&#39;t fetch </span><span class="si">$</span><span class="n">url</span><span class="s">, skipping&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">}.</span><span class="n">toMap</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>Our minimal example in this style:</p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">annotation</span><span class="p">.</span><span class="n">experimental</span>
<span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">concurrent</span><span class="p">.</span><span class="n">*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">concurrent</span><span class="p">.</span><span class="nn">duration</span><span class="p">.</span><span class="n">*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">concurrent</span><span class="p">.</span><span class="nc">ExecutionContext</span><span class="p">.</span><span class="nc">Implicits</span><span class="p">.</span><span class="n">global</span>

<span class="k">import</span><span class="w"> </span><span class="nn">cps</span><span class="p">.</span><span class="n">*</span><span class="w">                         </span><span class="c1">//  import cps</span>
<span class="k">import</span><span class="w"> </span><span class="nn">cps</span><span class="p">.</span><span class="nn">monads</span><span class="p">.{</span><span class="n">*</span><span class="p">,</span><span class="k">given</span><span class="p">}</span><span class="w">          </span><span class="c1">//  import support for build-in monads (i.e. Future)</span>


<span class="nd">@experimental</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">TestMinimalExample</span><span class="p">:</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">fetchGreeting</span><span class="p">()(</span><span class="k">using</span><span class="w"> </span><span class="nc">CpsDirect</span><span class="p">[</span><span class="nc">Future</span><span class="p">]):</span><span class="w"> </span><span class="nc">String</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;Hi.&quot;</span><span class="w">  </span><span class="c1">// assume this is a real async operation</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">greet</span><span class="p">()(</span><span class="k">using</span><span class="w"> </span><span class="nc">CpsDirect</span><span class="p">[</span><span class="nc">Future</span><span class="p">])</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">greeting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchGreeting</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="n">greeting</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">]):</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="p">[</span><span class="nc">Future</span><span class="p">]{</span><span class="w"> </span><span class="n">greet</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="nc">Await</span><span class="p">.</span><span class="n">ready</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="nc">Duration</span><span class="p">(</span><span class="mi">1</span><span class="p">.</span><span class="n">seconds</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="n">f</span><span class="p">.</span><span class="n">failed</span><span class="p">.</span><span class="n">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ex</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">println</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">getMessage</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>I.e. function accept external context parameter of form <cite>CpsDirect[F]</cite> and return type is an ordinary value not wrapped in monad.
The developer can call such function from an async block or other function with the direct context.
Note, that signature also can be written in carried form: <cite>def fetchGreeting(): CpsDirect[F] ?=&gt; String</cite>.</p>
<p>We can freely use <cite>await</cite> inside this direct context functions. Sometimes, we need to transform the synchronous style into asynchronous. We can do this using nested async expression or pseudo operator <cite>asynchronized</cite>  (reified with reify/reflect syntax), which uses current context for inferring the monad type. For example, here is a version of <cite>fetchAccessibe</cite> which fetch url-s in parallel:</p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">fetchAccessible</span><span class="p">(</span><span class="n">urls</span><span class="p">:</span><span class="nc">List</span><span class="p">[</span><span class="nc">String</span><span class="p">])(</span><span class="k">using</span><span class="w"> </span><span class="nc">CpsDirect</span><span class="p">[</span><span class="nc">Future</span><span class="p">]):</span><span class="w"> </span><span class="nc">Map</span><span class="p">[</span><span class="nc">String</span><span class="p">,</span><span class="nc">String</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">       </span><span class="n">urls</span><span class="p">.</span><span class="n">map</span><span class="p">{</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">              </span><span class="n">asynchronized</span><span class="p">(</span><span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">           </span><span class="p">.</span><span class="n">flatMap</span><span class="p">{</span><span class="w"> </span><span class="n">fetchingUrl</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">            </span><span class="k">try</span><span class="w"></span>
<span class="w">                </span><span class="nc">Some</span><span class="p">((</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">await</span><span class="p">(</span><span class="n">fetchingUrl</span><span class="p">)))</span><span class="w"></span>
<span class="w">            </span><span class="k">catch</span><span class="w"></span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="nc">NonFatal</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"></span>
<span class="w">                   </span><span class="n">logger</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">s&quot;Can&#39;t fetch </span><span class="si">$</span><span class="n">url</span><span class="s">, skipping&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"></span>
<span class="w">       </span><span class="p">}.</span><span class="n">toMap</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>Note, that in current version (0.21) direct context encoding is marked to be experimental.</p>
</section>
<section id="alternative-names">
<h2>Alternative names<a class="headerlink" href="#alternative-names" title="Permalink to this heading">¶</a></h2>
<p><cite>async(asynchronized)/await</cite>  names is appropriate for Future-s and effect monads. There are other monads where a  direct style can be helpful
in applications such as probabilistic programming, navigation over search space, collections, and many other.
We define alternative names for macros: <cite>reify(reifed)/reflect</cite>, which can be more appropriate in the general case:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">bayesianCoin</span><span class="p">(</span><span class="n">nFlips</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">):</span><span class="w"> </span><span class="nc">Distribution</span><span class="p">[</span><span class="nc">Trial</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reify</span><span class="p">[</span><span class="nc">Distribution</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">haveFairCoin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reflect</span><span class="p">(</span><span class="n">tf</span><span class="p">())</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">myCoin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">haveFairCoin</span><span class="p">)</span><span class="w"> </span><span class="n">coin</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">biasedCoin</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="kd">val</span><span class="w"> </span><span class="n">flips</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reflect</span><span class="p">(</span><span class="n">myCoin</span><span class="p">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">nFlips</span><span class="p">))</span><span class="w"></span>
<span class="w">      </span><span class="nc">Trial</span><span class="p">(</span><span class="n">haveFairCoin</span><span class="p">,</span><span class="w"> </span><span class="n">flips</span><span class="p">)</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">cps</span><span class="p">.</span><span class="n">*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">cps</span><span class="p">.</span><span class="nn">monads</span><span class="p">.{</span><span class="n">*</span><span class="p">,</span><span class="k">given</span><span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">allPairs</span><span class="p">[</span><span class="nc">T</span><span class="p">](</span><span class="n">l</span><span class="p">:</span><span class="w"> </span><span class="nc">List</span><span class="p">[</span><span class="nc">T</span><span class="p">]):</span><span class="w"> </span><span class="nc">List</span><span class="p">[(</span><span class="nc">T</span><span class="p">,</span><span class="nc">T</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reify</span><span class="p">[</span><span class="nc">List</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="p">(</span><span class="n">reflect</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="n">reflect</span><span class="p">(</span><span class="n">l</span><span class="p">))</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Yet one pair of names ‘lift/unlift’, used for example in the <a class="reference external" href="https://github.com/monadless/monadless"><code class="docutils literal notranslate"><span class="pre">monadless</span></code></a> library by Flavio W. Brasill,  can be enabled by importing <cite>cps.syntax.monadless.*</cite>.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">cps</span><span class="p">.</span><span class="n">*</span>
<span class="k">import</span><span class="w"> </span><span class="nn">cps</span><span class="p">.</span><span class="nn">syntax</span><span class="p">.</span><span class="nn">monadless</span><span class="p">.</span><span class="n">*</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TestMonadlessSyntax</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w"> </span><span class="k">import</span><span class="w"> </span><span class="nn">cps</span><span class="p">.</span><span class="nn">monads</span><span class="p">.</span><span class="nc">FutureAsyncMonad</span>

<span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="n">responseString</span><span class="p">:</span><span class="w"> </span><span class="nc">Future</span><span class="p">[</span><span class="nc">String</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lift</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">responseToString</span><span class="p">(</span><span class="n">unlift</span><span class="p">(</span><span class="n">badRequest</span><span class="p">.</span><span class="n">get</span><span class="p">))</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="k">case</span><span class="w"> </span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="nc">Exception</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">s&quot;received an exceptional result: </span><span class="si">$</span><span class="n">e</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p class="rubric">Footnotes</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="f1" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>The definitions of <a class="reference external" href="https://github.com/rssh/dotty-cps-async/blob/master/shared/src/main/scala/cps/Async.scala#L30"><code class="docutils literal notranslate"><span class="pre">async</span></code></a> and <a class="reference external" href="https://github.com/rssh/dotty-cps-async/blob/master/shared/src/main/scala/cps/Async.scala#L19"><code class="docutils literal notranslate"><span class="pre">await</span></code></a> are simplified, in reality they are more complex, because we want to infer the type of the expression independently from the type of monad.</p>
</aside>
</aside>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Dependency</a><ul>
<li><a class="reference internal" href="#sbt-example">Sbt Example</a></li>
<li><a class="reference internal" href="#compiler-plugin">Compiler Plugin</a></li>
<li><a class="reference internal" href="#loom-support-on-jvm">Loom support on JVM</a></li>
</ul>
</li>
<li><a class="reference internal" href="#basic-usage">Basic Usage</a><ul>
<li><a class="reference internal" href="#traditional-async-await-interface">Traditional async/await interface</a></li>
<li><a class="reference internal" href="#direct-context-encoding-experimental">Direct context encoding. (experimental)</a></li>
<li><a class="reference internal" href="#alternative-names">Alternative names</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="index.html"
                          title="previous chapter">User Manual</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="HighOrderFunctions.html"
                          title="next chapter">High-order functions.</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/BasicUsage.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="HighOrderFunctions.html" title="High-order functions."
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="User Manual"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">dotty-cps-async 0.9.21 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Dependency</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020-2024, Ruslan Shevchenko.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.2.3.
    </div>
  </body>
</html>